<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Daily Inspection Form (Local Storage - 149 Fields)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Your existing CSS remains unchanged */
    body {
       background-color: #f0f2f5;
       font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
       padding: 15px;
       margin: 0;
       overflow-x: hidden;
    }
    /* ... [Rest of your existing CSS] ... */
  </style>
</head>
<body>
  <div class="container">
    <form id="inspectionForm">
      <!-- Page 1: Weightbridge System -->
      <div id="page1" class="page-container">
        <div class="loading-overlay" id="loading1"><div class="spinner"></div></div>
        <h2 class="page-header">Weightbridge System</h2>
        <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Date</div>
            <input type="date" class="form-control" name="txtDate" required>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Inspected by</div>
            <select class="form-select" name="cmbInspector" required>
              <option value="I(TD)41">I(TD)41</option>
              <option value="I(TD)42">I(TD)42</option>
              <option value="I(TD)43">I(TD)43</option>
              <option value="I(TD)44">I(TD)44</option>
              <option value="I(TD)45">I(TD)45</option>
              <option value="I(TD)46">I(TD)46</option>
              <option value="I(TD)47">I(TD)47</option>
              <option value="I(EI)45">I(EI)45</option>
            </select>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Time</div>
            <input type="text" class="form-control" name="txtTime" pattern="^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$"
                   placeholder="e.g., 14:23" required>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Weather</div>
            <select class="form-select" name="cmbWeather" required>
              <option value="Sunny">Sunny</option>
              <option value="Fine">Fine</option>
              <option value="Cloudy">Cloudy</option>
              <option value="Rainy">Rainy</option>
            </select>
          </div>
        </div>
        <!-- ... [Rest of Page 1 content unchanged] ... -->
        <div class="navigation-buttons">
          <button type="button" class="btn-next" id="next1">Next</button>
        </div>
      </div>

      <!-- Page 2: Tipping Operation -->
      <div id="page2" class="page-container hidden">
        <div class="loading-overlay" id="loading2"><div class="spinner"></div></div>
        <h2 class="page-header">Vehicle Wash & Tank Farm</h2>
        <!-- ... [Rest of Page 2 content unchanged] ... -->
        <div class="navigation-buttons">
          <button type="button" class="btn-previous" id="prev2">Previous</button>
          <button type="button" class="btn-next" id="next2">Next</button>
        </div>
      </div>

      <!-- Page 3: Air Monitoring -->
      <div id="page3" class="page-container hidden">
        <div class="loading-overlay" id="loading3"><div class="spinner"></div></div>
        <h2 class="page-header">Air Monitoring</h2>
        <!-- ... [Rest of Page 3 content unchanged] ... -->
        <div class="navigation-buttons">
          <button type="button" class="btn-previous" id="prev3">Previous</button>
          <button type="button" class="btn-next" id="next3">Next</button>
        </div>
      </div>

      <!-- Page 4: Meter Reading -->
      <div id="page4" class="page-container hidden">
        <div class="loading-overlay" id="loading4"><div class="spinner"></div></div>
        <h2 class="page-header">Air Monitoring</h2>
        <!-- ... [Rest of Page 4 content unchanged] ... -->
        <div class="navigation-buttons">
          <button type="button" class="btn-previous" id="prev4">Previous</button>
          <button type="submit" class="btn-save" id="save">Save</button>
        </div>
      </div>
    </form>
    <p id="status" class="mt-3"></p>
    <button class="btn-export" id="exportExcelBtn">Export to Excel</button>
    
    <!-- Voice control buttons -->
    <div class="voice-controls" style="margin: 20px auto; text-align: center;">
      <button id="startVoice" class="btn-voice" style="background-color: #4a90e2; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">開始語音輸入</button>
      <button id="pauseVoice" class="btn-voice" style="background-color: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; display: none;">暫停語音輸入</button>
      <p id="voiceStatus" style="margin-top: 10px; color: #444;"></p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let currentPage = 1;
    const pages = ['page1', 'page2', 'page3', 'page4'];
    let db;
    let dbInitialized = false;

    // Voice input variables
    let recognition;
    let isPaused = false;
    let currentInputField = null;

    // Voice recognition setup
    function initializeVoiceRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        showStatus('抱歉，您的瀏覽器不支持語音輸入功能', 'error');
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'yue-Hant-HK'; // Cantonese (Hong Kong)

      recognition.onstart = () => {
        document.getElementById('startVoice').style.display = 'none';
        document.getElementById('pauseVoice').style.display = 'inline-block';
        document.getElementById('voiceStatus').textContent = '語音輸入已啟動...';
        showStatus('語音輸入已開始');
      };

      recognition.onresult = (event) => {
        if (isPaused) return;

        const transcript = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('');
        
        if (currentInputField) {
          if (currentInputField.type === 'checkbox') {
            if (transcript.includes('勾選') || transcript.includes('檢查')) {
              currentInputField.checked = true;
            } else if (transcript.includes('取消') || transcript.includes('唔勾')) {
              currentInputField.checked = false;
            }
          } else if (currentInputField.tagName === 'SELECT') {
            const options = Array.from(currentInputField.options);
            const matchedOption = options.find(opt => 
              transcript.toLowerCase().includes(opt.text.toLowerCase())
            );
            if (matchedOption) {
              currentInputField.value = matchedOption.value;
            }
          } else {
            currentInputField.value = transcript;
            if (currentInputField.name === 'txtTime') {
              formatTimeInput(currentInputField);
            }
          }
          currentInputField.dispatchEvent(new Event('input'));
        }
      };

      recognition.onerror = (event) => {
        showStatus(`語音輸入錯誤: ${event.error}`, 'error');
        stopVoiceRecognition();
      };

      recognition.onend = () => {
        if (!isPaused) {
          stopVoiceRecognition();
        }
      };
    }

    function startVoiceRecognition() {
      if (!recognition) {
        initializeVoiceRecognition();
      }
      
      // Find the first visible input field on current page
      const visibleInputs = Array.from(document.querySelectorAll(`#page${currentPage} input, #page${currentPage} select`))
        .filter(input => !input.closest('.hidden'));
      currentInputField = visibleInputs[0];
      
      recognition.start();
      isPaused = false;
    }

    function pauseVoiceRecognition() {
      if (recognition) {
        recognition.stop();
        isPaused = true;
        document.getElementById('startVoice').style.display = 'inline-block';
        document.getElementById('pauseVoice').style.display = 'none';
        document.getElementById('voiceStatus').textContent = '語音輸入已暫停';
        showStatus('語音輸入已暫停');
      }
    }

    function stopVoiceRecognition() {
      if (recognition) {
        recognition.stop();
        document.getElementById('startVoice').style.display = 'inline-block';
        document.getElementById('pauseVoice').style.display = 'none';
        document.getElementById('voiceStatus').textContent = '';
        showStatus('語音輸入已停止');
        isPaused = false;
      }
    }

    const initDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('InspectionDB', 3);

        request.onupgradeneeded = (e) => {
          console.log('Database upgrade needed');
          db = e.target.result;
          if (!db.objectStoreNames.contains('inspections')) {
            db.createObjectStore('inspections', { keyPath: 'timestamp' });
            console.log('Object store "inspections" created');
          }
        };

        request.onsuccess = (e) => {
          db = e.target.result;
          dbInitialized = true;
          console.log('Database initialized successfully');
          setDefaultValues();
          resolve(db);
        };

        request.onerror = (e) => {
          console.error('Database error:', e.target.error);
          showStatus(`Database error: ${e.target.error.message}. Please try refreshing.`, 'error');
          reject(e.target.error);
        };

        request.onblocked = (e) => {
          console.error('Database blocked:', e);
          showStatus('Database is blocked. Please close other tabs.', 'error');
          reject(new Error('Database blocked'));
        };
      });
    };

    // Placeholder for setDefaultValues (excluded as requested)
    const setDefaultValues = () => {
      // Your original setDefaultValues function would go here
    };

    const showPage = (pageNum) => {
      pages.forEach(p => document.getElementById(p).classList.add('hidden'));
      document.getElementById(`page${pageNum}`).classList.remove('hidden');
    };

    const showStatus = (message, type = 'success') => {
      const status = document.getElementById('status');
      status.textContent = '';
      status.appendChild(document.createTextNode(message));
      status.style.color = type === 'error' ? '#e74c3c' : '#27ae60';
      setTimeout(() => status.textContent = '', 5000);
    };

    const validateForm = (data) => {
      if (!data.txtDate) return "Date is required";
      if (!data.txtTime.match(/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$/)) return "Invalid time format (HH:MM)";
      if (!data.cmbInspector) return "Inspector is required";
      if (!data.cmbWeather) return "Weather is required";
      return null;
    };

    const showLoading = (pageNum, show) => {
      document.getElementById(`loading${pageNum}`).style.display = show ? 'flex' : 'none';
    };

    const saveLocally = (data) => {
      return new Promise((resolve, reject) => {
        if (!dbInitialized || !db) {
          reject(new Error('Database not initialized'));
          return;
        }
        const tx = db.transaction('inspections', 'readwrite');
        const store = tx.objectStore('inspections');
        const request = store.add(data);

        request.onsuccess = () => {
          console.log('Data saved successfully:', data);
          resolve();
        };

        request.onerror = (e) => {
          console.error('Error saving data:', e.target.error);
          reject(e.target.error);
        };
      });
    };

    const formatTimeInput = (input) => {
      let value = input.value.replace(/[^0-9]/g, '');
      if (value.length === 4) {
        const hours = value.slice(0, 2);
        const minutes = value.slice(2, 4);
        if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
          input.value = `${hours}:${minutes}`;
        } else {
          input.value = '';
          showStatus('Invalid time: Hours (00-23) or Minutes (00-59)', 'error');
        }
      }
    };

    const resetForm = () => {
      const form = document.getElementById('inspectionForm');
      form.reset();
      console.log('Form reset called');
      localStorage.clear();
      console.log('LocalStorage cleared');

      document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
        input.value = '';
        input.defaultValue = '';
        console.log(`Cleared input ${input.name}: ${input.value}`);
      });

      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
        console.log(`Reset checkbox ${checkbox.name}`);
      });

      document.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
        console.log(`Reset select ${select.name} to ${select.value}`);
      });

      setDefaultValues();
      console.log('Default values reapplied');
    };

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing DB...');
      initDB()
        .then(() => {
          console.log('DB initialized, showing page 1');
          showPage(1);
          const timeInput = document.querySelector('input[name="txtTime"]');
          timeInput.addEventListener('input', (e) => formatTimeInput(e.target));
          
          // Add voice control event listeners
          document.getElementById('startVoice').addEventListener('click', startVoiceRecognition);
          document.getElementById('pauseVoice').addEventListener('click', pauseVoiceRecognition);
          
          // Add click handler for field selection during voice input
          document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('click', (e) => {
              if (recognition && !isPaused) {
                currentInputField = e.target;
              }
            });
          });
        })
        .catch((error) => console.error('Initialization error:', error));
    });

    document.querySelector('.container').addEventListener('click', (e) => {
      const targetId = e.target.id;
      if (targetId.startsWith('next') && currentPage < pages.length) {
        currentPage++;
        showPage(currentPage);
      } else if (targetId.startsWith('prev') && currentPage > 1) {
        currentPage--;
        showPage(currentPage);
      }
    });

    document.getElementById('inspectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Form submission started');
      showLoading(4, true);

      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.timestamp = new Date().toISOString();
        console.log('Form data collected:', data);

        const timeInput = document.querySelector('input[name="txtTime"]');
        if (!timeInput.value) {
          const now = new Date();
          timeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          data.txtTime = timeInput.value;
        }

        const checkboxes = [
          "chkWeightbridge1", "chkWeightbridge2", "chkWeightbridge3", "chkWeightbridge4",
          "chktipping1", "chktipping2", "chkC1", "chkC2", "chkC3", "chkC4", "chkC5",
          "chkC6", "chkC7", "chkC8", "chkC9", "chkC10", "chkScreen1", "chkScreen2",
          "chkScreen3", "chkDAF1", "chkDAF2", "chkCrane1", "chkCrane2", "chkCHU1",
          "chkCHU2", "chkLaiwan", "chkNgonshuen", "chkWash1", "chkWash2", "chkWash3",
          "chkScrubber1", "chkScrubber2", "chkScrubber3", "chkScrubber4", "chkScrubber5",
          "chkT300", "chkT401", "chkT402", "chkT403", "chkT404", "chkMF1", "chkMF2",
          "chkMF3", "chkMF4", "chkMF5", "chkMF6"
        ];

        checkboxes.forEach(name => {
          data[name] = formData.has(name) ? "true" : "false";
        });

        const validationError = validateForm(data);
        if (validationError) {
          console.warn('Validation failed:', validationError);
          showStatus(validationError, 'error');
          showLoading(4, false);
          return;
        }

        console.log('Attempting to save data locally...');
        await saveLocally(data);
        console.log('Data saved successfully');
        showStatus('Data saved locally!');
      } catch (error) {
        console.error('Save failed:', error);
        showStatus(`Failed to save data: ${error.message}`, 'error');
      } finally {
        console.log('Submission process completed');
        showLoading(4, false);
      }
    });

    document.getElementById('exportExcelBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      if (typeof XLSX === 'undefined') {
        showStatus('Excel library not loaded. Check your connection.', 'error');
        return;
      }
      if (!confirm('Export all local data to Excel and clear the database?')) return;

      showLoading(currentPage, true);

      try {
        if (!dbInitialized || !db) {
          console.log('Database not initialized, retrying...');
          await initDB();
          if (!dbInitialized) throw new Error('Database failed to initialize');
        }

        const tx = db.transaction('inspections', 'readonly');
        const store = tx.objectStore('inspections');
        const data = await new Promise((resolve, reject) => {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(new Error('Failed to retrieve data'));
        });

        if (!data || data.length === 0) {
          showStatus('No local data to export', 'error');
          return;
        }

        const reformatDate = (dateStr) => {
          if (!dateStr) return '';
          if (dateStr.includes('-')) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
          }
          return dateStr;
        };

        // Headers array excluded as requested
        const headers = []; // Placeholder - your original headers would go here

        const fieldNames = [
          "txtDate", "cmbInspector", "txtTime", "cmbWeather", "chkWeightbridge1", "chkWeightbridge2",
          "chkWeightbridge3", "chkWeightbridge4", "cmbCCTV", "cmbWeightDis", "bridgeWasteV",
          "bridgeWasteT", "cmbPermitedW", "cmboffQ", "chktipping1", "chktipping2", "tippingWasteV",
          "tippingWasteT", "cmbtippingPermitedW", "cmbtippingTraffic", "cmbtippingCCTV", "txtfPress",
          "chkC1", "txtC1", "chkC2", "txtC2", "chkMF1", "chkC3", "txtC3", "chkMF2", "chkC4",
          "txtC4", "chkMF3", "chkC5", "txtC5", "chkMF4", "chkC6", "txtC6", "chkMF5", "chkC7",
          "txtC7", "chkMF6", "chkC8", "txtC8", "chkC9", "txtC9", "chkC10", "txtC10", "chkScreen1",
          "chkScreen2", "chkScreen3", "txt1A", "txt1B", "txt2A", "txt2B", "chkDAF1", "chkDAF2",
          "cmbGTW", "chkCrane1", "chkCrane2", "chkCHU1", "chkCHU2", "txt145B", "txt550FV",
          "txt155W", "txtOthers", "chkLaiwan", "chkNgonshuen", "chkWash1", "chkWash2", "chkWash3",
          "cmbCleanliness", "cmbMinutes", "cmbHours", "cmbCurtain", "chkScrubber1", "chkScrubber2",
          "chkScrubber3", "chkScrubber4", "chkScrubber5", "txtAcid1", "txtAcid2", "txtAcid4",
          "txtAcid5", "txtAlk1", "txtAlk2", "txtAlk3", "txtAlk4", "txtAlk5", "txtORP1", "txtORP2",
          "txtORP3", "txtORP4", "txtORP5", "cmbBefore", "cmbAnaerobic", "chkT300", "chkT401",
          "chkT402", "chkT403", "chkT404", "cmbFinal", "cmbFilter", "cmbBiogas", "cmbPenstock",
          "txtRemarks1", "txtRemarks2", "txtRemarks3", "txtRemarks4", "cmbPLC", "cmbPreT",
          "cmbPenstockChamber", "cmbAerobicS", "txtAT401", "txtAT402", "txtAT403", "txtAT404",
          "cmbAnaerobicS", "txtApH", "txtATemp", "txtADO", "txtABiogas", "cmbPostT", "cmbCent",
          "txtWetsep", "txtMarineVessel", "txtStorm", "txtVWF", "txtRundown", "txt101", "txt100",
          "txt313", "txt312", "txt410", "txt413", "txtPublic", "txtRoad", "txtMarine", "txtScrubbers",
          "txtVWS", "txt401DO", "txt402DO", "txt403DO", "txt404DO", "txt401Temp", "txt402Temp",
          "txt403Temp", "txt404Temp", "txt404pH", "timestamp"
        ];

        const worksheetData = [
          headers,
          ...data.map(item => fieldNames.map(field => {
            if (field === "txtDate" && item[field]) {
              return reformatDate(item[field]);
            }
            return item[field] || '';
          }))
        ];

        const ws = XLSX.utils.aoa_to_sheet(worksheetData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inspections");

        const now = new Date();
        const hktDate = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        const timestamp = `${hktDate.getUTCFullYear()}${String(hktDate.getUTCMonth() + 1).padStart(2, '0')}${String(hktDate.getUTCDate()).padStart(2, '0')}_${String(hktDate.getUTCHours()).padStart(2, '0')}${String(hktDate.getUTCMinutes()).padStart(2, '0')}${String(hktDate.getUTCSeconds()).padStart(2, '0')}`;
        XLSX.writeFile(wb, `inspections_${timestamp}.xlsx`);

        const clearDB = () => {
          return new Promise((resolve, reject) => {
            const tx = db.transaction('inspections', 'readwrite');
            const store = tx.objectStore('inspections');
            const request = store.clear();
            request.onsuccess = () => {
              console.log('IndexedDB cleared');
              resolve();
            };
            request.onerror = (e) => reject(e.target.error);
          });
        };

        await clearDB();
        resetForm();

        setTimeout(() => {
          document.querySelectorAll('input, select, textarea').forEach(element => {
            element.dispatchEvent(new Event('change'));
            element.dispatchEvent(new Event('input'));
          });
          console.log('DOM refresh forced');
          showStatus('Data exported successfully and form cleared');
        }, 100);

      } catch (error) {
        console.error('Export error:', error);
        showStatus(`Export failed: ${error.message}`, 'error');
      } finally {
        showLoading(currentPage, false);
      }
    });

    document.querySelectorAll('input, textarea, select').forEach(function(element) {
      element.addEventListener('input', function() {
        localStorage.setItem(element.name, element.value);
      });
    });

    window.addEventListener('load', function() {
      document.querySelectorAll('input, textarea, select').forEach(function(element) {
        const savedValue = localStorage.getItem(element.name);
        if (savedValue) {
          element.value = savedValue;
        }
      });
      setDefaultValues();
    });
  </script>
</body>
</html>
