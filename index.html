<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Daily Inspection Form (Local Storage - 149 Fields)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
       background-color: #f0f2f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 15px; /* Reduced padding for mobile */
    margin: 0;
    overflow-x: hidden;
}

.page-container {
    background-color: #ffffff;
    padding: 15px; /* Reduced padding for mobile */
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 20px;
    width: 100%; /* Changed from fixed 1200px */
    max-width: 1200px; /* Added max-width instead */
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    position: relative;
    }
    .page-header {
      color: #ffffff;
      font-weight: 700;
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.6rem;
      background-color: #4a90e2;
      padding: 10px;
      border-radius: 5px;
    }
    .form-label {
      font-weight: 500;
      color: #444;
      margin-bottom: 5px;
      display: block;
      font-size: 0.95rem;
      width: 140px;
      float: left;
      margin-right: 15px;
      line-height: 35px;
    }
    .form-control, .form-select {
      border-radius: 5px;
      border: 1px solid #d0d0d0;
      padding: 0 12px;
      font-size: 0.95rem;
      width: 220px;
      height: 35px;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
      display: inline-block;
      vertical-align: middle;
      background-color: #fafafa;
      color: #333;
      box-sizing: border-box;
      transition: border-color 0.2s;
      line-height: 33px;
      text-align: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .form-select:focus {
      border-color: #4a90e2;
      outline: none;
    }
    .form-check-input {
      transform: scale(1.4);
      margin-right: 10px;
      vertical-align: middle;
    }
    .form-check-label {
      color: #444;
      font-size: 0.9rem;
      line-height: 35px;
      vertical-align: middle;
    }
    .navigation-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 30px;
      gap: 10px;
    }
    .btn-previous {
      background-color: #f39c12;
      border: none;
      padding: 10px 25px;
      font-size: 1rem;
      border-radius: 5px;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-previous:hover {
      background-color: #e67e22;
    }
    .btn-next, .btn-save {
      background-color: #2ecc71;
      border: none;
      padding: 10px 25px;
      font-size: 1rem;
      border-radius: 5px;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-next:hover, .btn-save:hover {
      background-color: #27ae60;
    }
    #status {
      text-align: center;
      font-weight: 500;
      margin-top: 15px;
      font-size: 1rem;
    }
    .row {
      margin-bottom: 15px;
      clear: both;
    }
    .hidden {
      display: none;
    }
    .field-group {
      margin-bottom: 10px;
      position: relative;
      display: flex;
      align-items: center;
    }
    .section-header {
      font-weight: 600;
      color: #444;
      margin-top: 20px;
      margin-bottom: 15px;
      font-size: 1.2rem;
      padding: 0 0 4px 0;
      background-color: transparent;
      clear: both;
      position: relative;
    }
    .section-header::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 3px;
      background-color: #2ecc71;
    }
    .section-group {
      background-color: #f9f9f9;
      padding: 15px;
      border: 1px solid #e8ecef;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .btn-export {
      background-color: #2980b9;
      color: white;
      padding: 12px 30px;
      border-radius: 5px;
      border: none;
      margin: 20px auto;
      display: block;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s;
    }
    .btn-export:hover { background-color: #1f6391; }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #fff;
      border-top-color: #2ecc71;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Enhanced Media Queries */
@media (max-width: 1024px) {
    .page-container {
        padding: 15px;
    }
    
    .form-label {
        width: 120px;
        margin-right: 10px;
    }
    
    .form-control, .form-select {
        width: calc(100% - 130px);
    }
}

@media (max-width: 768px) {
    .page-container {
        padding: 10px;
    }
    
    .form-label {
        width: 100%;
        float: none;
        margin-right: 0;
        line-height: 1.5;
        margin-bottom: 5px;
    }
    
    .form-control, .form-select {
        width: 100%;
        font-size: 0.9rem;
    }
    
    .field-group {
        margin-bottom: 15px;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .navigation-buttons {
        flex-direction: column;
        gap: 10px;
        justify-content: center;
        align-items: stretch;
    }
    
    .btn-previous, .btn-next, .btn-save {
        width: 100%;
        padding: 12px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 10px;
    }
    
    .page-header {
        font-size: 1.2rem;
        padding: 8px;
    }
    
    .section-header {
        font-size: 1rem;
    }
    
    .form-control, .form-select {
        height: 40px;
        font-size: 0.85rem;
    }
    
    .form-check-input {
        transform: scale(1.2);
    }
    
    .btn-export {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
}

/* Landscape orientation specific adjustments */
@media (max-width: 896px) and (orientation: landscape) {
    .page-container {
        padding: 10px;
    }
    
    .form-label {
        width: 100px;
        font-size: 0.85rem;
    }
    
    .form-control, .form-select {
        width: calc(100% - 110px);
        height: 32px;
        font-size: 0.85rem;
    }
    
    .field-group {
        margin-bottom: 8px;
    }
    
    .navigation-buttons {
        flex-direction: row;
        gap: 5px;
    }
    
    .btn-previous, .btn-next, .btn-save {
        padding: 8px 15px;
        font-size: 0.9rem;
    }
    
    .section-header {
        margin-top: 15px;
        margin-bottom: 10px;
    }
}

/* Small phones in landscape */
@media (max-width: 667px) and (orientation: landscape) {
    .form-label {
        width: 80px;
    }
    
    .form-control, .form-select {
        width: calc(100% - 90px);
    }
    
    .page-header {
        font-size: 1.1rem;
    }
}
/* Add this CSS to make text uppercase */
input[type="text"], textarea {
    text-transform: uppercase;
}
</style>
</head>
<body>
  <div class="container">
    <form id="inspectionForm">
      <!-- Page 1: Weightbridge System -->
      <div id="page1" class="page-container">
        <div class="loading-overlay" id="loading1"><div class="spinner"></div></div>
                <h2 class="page-header">Vehicle Wash & Tank Farm</h2>
        <div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Vehicle Wash</h3>
          </div>
        </div>
	<div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Vehicle Wash 1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkWash1">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Vehicle Wash 2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkWash2">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          </div>
<div class="row">
<div class="col-md-3 field-group">
            <div class="form-label">Storm Reading</div>
            <input type="text" class="form-control" name="txtStorm">
          </div>
</div>

<div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Cleanliness</div>
            <select class="form-select" name="cmbCleanliness">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">>30 mins</div>
            <select class="form-select" name="cmbMinutes">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Offsite Litter >24 hrs</div>
            <select class="form-select" name="cmbHours">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
<div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">GTW Area</h3>
          </div>
        </div>
 <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Screen 1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScreen1">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Screen 2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScreen2">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Screen 3</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScreen3">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Tank 1A</div>
            <input type="text" class="form-control" name="txt1A">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Tank 1B</div>
            <input type="text" class="form-control" name="txt1B">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Tank 2A</div>
            <input type="text" class="form-control" name="txt2A">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Tank 2B</div>
            <input type="text" class="form-control" name="txt2B">
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">DAF 1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkDAF1">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">DAF 2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkDAF2">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">GTW Area</div>
            <select class="form-select" name="cmbGTW">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>        

     <div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Tank Farm Meters</h3>
          </div>
        </div>
                <div class="row">
			<div class="col-md-3 field-group">
            <div class="form-label">313</div>
            <input type="text" class="form-control" name="txt313">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">312</div>
            <input type="text" class="form-control" name="txt312">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">101</div>
            <input type="text" class="form-control" name="txt101">
          </div>
		<div class="col-md-3 field-group">
            <div class="form-label">410</div>
            <input type="text" class="form-control" name="txt410">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">100</div>
            <input type="text" class="form-control" name="txt100">
          </div>
 <div class="col-md-3 field-group">
            <div class="form-label">Wetsep</div>
            <input type="text" class="form-control" name="txtWetsep">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Marine Vessel</div>
            <input type="text" class="form-control" name="txtMarineVessel">
          </div>

 <div class="row">
        
          <div class="col-md-4 field-group">
            <div class="form-label">AnaerobicS</div>
            <select class="form-select" name="cmbAnaerobicS">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
        </div>
<div class="row">         
<div class="col-md-4 field-group">
            <div class="form-label">ApH</div>
            <input type="text" class="form-control" name="txtApH">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">ATemp</div>
            <input type="text" class="form-control" name="txtATemp">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">ADO</div>
            <input type="text" class="form-control" name="txtADO">
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">ABiogas</div>
            <input type="text" class="form-control" name="txtABiogas">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Post-Treatment</div>
            <select class="form-select" name="cmbPostT">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Centrifuge</div>
            <select class="form-select" name="cmbCent">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
<div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Lai Wan</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkLaiwan">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Ngon Shuen</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkNgonshuen">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>

<div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Tank Farm & Wastewaster Meters</h3>
          </div>
        </div>

<div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">PLC Condition</div>
            <select class="form-select" name="cmbPLC">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Pre Treatment</div>
            <select class="form-select" name="cmbPreT">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Penstock Status</div>
            <select class="form-select" name="cmbPenstockChamber">
              <option value="Open">Open</option>
              <option value="Close">Close</option>
            </select>
          </div>            
        
          <div class="col-md-4 field-group">
            <div class="form-label">AerobicS</div>
            <select class="form-select" name="cmbAerobicS">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
</div>
<div class="row">
                      
 	<div class="col-md-3 field-group">
            <div class="form-label">413</div>
            <input type="text" class="form-control" name="txt413">
          </div>
     	 <div class="col-md-3 field-group">
            <div class="form-label">VWF</div>
            <input type="text" class="form-control" name="txtVWF">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Rundown</div>
            <input type="text" class="form-control" name="txtRundown">
          </div>
        </div>

<div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">AT401</div>
            <input type="text" class="form-control" name="txtAT401">
          </div>
<div class="col-md-4 field-group">
            <div class="form-label">401 DO</div>
            <input type="text" class="form-control" name="txt401DO">
          </div>
<div class="col-md-4 field-group">
            <div class="form-label">401 Temp</div>
            <input type="text" class="form-control" name="txt401Temp">
          </div>
</div>
	<div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">AT402</div>
            <input type="text" class="form-control" name="txtAT402">
          </div>
	<div class="col-md-4 field-group">
            <div class="form-label">402 DO</div>
            <input type="text" class="form-control" name="txt402DO">
          </div>
	<div class="col-md-4 field-group">
            <div class="form-label">402 Temp</div>
            <input type="text" class="form-control" name="txt402Temp">
          </div>
	</div>
	<div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">AT403</div>
            <input type="text" class="form-control" name="txtAT403">
          </div>
	<div class="col-md-4 field-group">
            <div class="form-label">403 DO</div>
            <input type="text" class="form-control" name="txt403DO">
          </div>
	<div class="col-md-4 field-group">
            <div class="form-label">403 Temp</div>
            <input type="text" class="form-control" name="txt403Temp">
          </div>
	</div>
	<div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">AT404</div>
            <input type="text" class="form-control" name="txtAT404">
          </div>
	<div class="col-md-4 field-group">
            <div class="form-label">404 DO</div>
            <input type="text" class="form-control" name="txt404DO">
          </div>
	<div class="col-md-4 field-group">
            <div class="form-label">404 Temp</div>
            <input type="text" class="form-control" name="txt404Temp">
          </div>

          <div class="col-md-4 field-group">
            <div class="form-label">404 pH</div>
            <input type="text" class="form-control" name="txt404pH">
          </div>
	</div>
	</div>


        <div class="navigation-buttons">
          <button type="button" class="btn-next" id="next1">Next</button>
        </div>
      </div>


<!-- Page 2: Tipping Operation -->
      <div id="page2" class="page-container hidden">
        <div class="loading-overlay" id="loading2"><div class="spinner"></div></div>
        
<h2 class="page-header">Air Monitoring</h2>
        

<div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Compactors & Equipment</h3>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Filter Press</div>
            <input type="text" class="form-control" name="txtfPress">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">C1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC1">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C1)</div>
            <input type="text" class="form-control" name="txtC1" value="---">
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC2" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C2)</div>
            <input type="text" class="form-control" name="txtC2">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">MF1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkMF1" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C3</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC3" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C3)</div>
            <input type="text" class="form-control" name="txtC3">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">MF2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkMF2" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C4</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC4" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C4)</div>
            <input type="text" class="form-control" name="txtC4">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">MF3</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkMF3" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C5</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC5" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C5)</div>
            <input type="text" class="form-control" name="txtC5">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">MF4</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkMF4" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C6</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC6" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C6)</div>
            <input type="text" class="form-control" name="txtC6">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">MF5</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkMF5" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C7</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC7" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C7)</div>
            <input type="text" class="form-control" name="txtC7">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">MF6</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkMF6" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C8</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC8" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C8)</div>
            <input type="text" class="form-control" name="txtC8">
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C9</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC9" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C9)</div>
            <input type="text" class="form-control" name="txtC9">
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">C10</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkC10" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Container No. (C10)</div>
            <input type="text" class="form-control" name="txtC10">
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Crane</h3>
          </div>
        </div>
 <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Crane 1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkCrane1">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Crane 2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkCrane2">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
       
 <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">CHU 1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkCHU1">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">CHU 2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkCHU2">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
</div>

        <div class="navigation-buttons">
          <button type="button" class="btn-previous" id="prev2">Previous</button>
          <button type="button" class="btn-next" id="next2">Next</button>
        </div>
      </div>




      <!-- Page 3: Air Monitoring -->
      <div id="page3" class="page-container hidden">
        <div class="loading-overlay" id="loading3"><div class="spinner"></div></div>
        <h2 class="page-header">Air Monitoring</h2>       

        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Air Curtain</div>
            <select class="form-select" name="cmbCurtain">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-2 field-group">
            <div class="form-label">Scrubber 1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScrubber1">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">Scrubber 2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScrubber2">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">Scrubber 3</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScrubber3">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">Scrubber 4</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScrubber4">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">Scrubber 5</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkScrubber5">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Acid Stage 5</div>
            <input type="text" class="form-control" name="txtAcid5">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">Alk Stage 5</div>
            <input type="text" class="form-control" name="txtAlk5">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">ORP Range 5</div>
            <input type="text" class="form-control" name="txtORP5">
          </div>
        </div>
         <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Acid Stage 4</div>
            <input type="text" class="form-control" name="txtAcid4">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">Alk Stage 4</div>
            <input type="text" class="form-control" name="txtAlk4">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">ORP Range 4</div>
            <input type="text" class="form-control" name="txtORP4">
          </div>
        </div>
         <div class="row">
          <div class="col-md-3 field-group">
          	   <div class="form-label">Alk Stage 3</div>
            <input type="text" class="form-control" name="txtAlk3">
          </div>
	<div class="col-md-4 field-group">
            <div class="form-label">ORP Range 3</div>
            <input type="text" class="form-control" name="txtORP3">
          </div>
        </div>
 <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Acid Stage 2</div>
            <input type="text" class="form-control" name="txtAcid2">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">Alk Stage 2</div>
            <input type="text" class="form-control" name="txtAlk2">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">ORP Range 2</div>
            <input type="text" class="form-control" name="txtORP2">
          </div>
        </div>
 <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Acid Stage 1</div>
            <input type="text" class="form-control" name="txtAcid1">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">Alk Stage 1</div>
            <input type="text" class="form-control" name="txtAlk1">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">ORP Range 1</div>
            <input type="text" class="form-control" name="txtORP1">
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Before Treatment</div>
            <select class="form-select" name="cmbBefore">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Anaerobic Tanks</div>
            <select class="form-select" name="cmbAnaerobic">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Water Monitoring</h3>
          </div>
        </div>
        <div class="row">
          <div class="col-md-2 field-group">
            <div class="form-label">T300</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkT300" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">T401</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkT401" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">T402</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkT402" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">T403</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkT403" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-2 field-group">
            <div class="form-label">T404</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkT404" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Final Clarifier</div>
            <select class="form-select" name="cmbFinal">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Filter Press</div>
            <select class="form-select" name="cmbFilter">
              <option value="Normal">Normal</option>
              <option value="Idle">Idle</option>
            </select>
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Biogas Tank</div>
            <select class="form-select" name="cmbBiogas">
              <option value="Normal">Normal</option>
              <option value="Full">Full</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Penstock</div>
            <select class="form-select" name="cmbPenstock">
              <option value="Open">Open</option>
              <option value="Close">Close</option>
            </select>
          </div>
        </div>
 <div class="row">
	<div class="col-md-3 field-group">
            <div class="form-label">Marine</div>
            <input type="text" class="form-control" name="txtMarine">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Public</div>
            <input type="text" class="form-control" name="txtPublic">
          </div>
	<div class="col-md-3 field-group">
            <div class="form-label">VWS</div>
            <input type="text" class="form-control" name="txtVWS">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Road</div>
            <input type="text" class="form-control" name="txtRoad">
          </div>
                    <div class="col-md-3 field-group">
            <div class="form-label">Scrubbers</div>
            <input type="text" class="form-control" name="txtScrubbers">
          </div>
           </div>


        <div class="navigation-buttons">
          <button type="button" class="btn-previous" id="prev3">Previous</button>
          <button type="button" class="btn-next" id="next3">Next</button>
        </div>
      </div>

      <!-- Page 4: Meter Reading -->
      <div id="page4" class="page-container hidden">
        <div class="loading-overlay" id="loading4"><div class="spinner"></div></div>             
	
<h2 class="page-header">Weightbridge System</h2>
        <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Date</div>
            <input type="date" class="form-control" name="txtDate" required>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Inspected by</div>
            <select class="form-select" name="cmbInspector" required>
              <option value="I(TD)41">I(TD)41</option>
              <option value="I(TD)42">I(TD)42</option>
              <option value="I(TD)43">I(TD)43</option>
              <option value="I(TD)44">I(TD)44</option>
              <option value="I(TD)45">I(TD)45</option>
              <option value="I(TD)46">I(TD)46</option>
              <option value="I(TD)47">I(TD)47</option>
              <option value="I(EI)45">I(EI)45</option>
            </select>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Time</div>
            <input type="text" class="form-control" name="txtTime" pattern="^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$"
                   placeholder="e.g., 14:23" required>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Weather</div>
            <select class="form-select" name="cmbWeather" required>
              <option value="Sunny">Sunny</option>
              <option value="Fine">Fine</option>
              <option value="Cloudy">Cloudy</option>
              <option value="Rainy">Rainy</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Weight Bridges in Operation</h3>
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">No. 1</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkWeightbridge1" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">No. 2</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkWeightbridge2" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">No. 3</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkWeightbridge3" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">No. 4</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chkWeightbridge4">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 field-group">
            <div class="form-label">CCTV Recording</div>
            <select class="form-select" name="cmbCCTV">
              <option value="Normal">Normal</option>
              <option value="Malfunction">Malfunction</option>
            </select>
          </div>
          <div class="col-md-6 field-group">
            <div class="form-label">Weight Display</div>
            <select class="form-select" name="cmbWeightDis">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Inspection of Waste Data Input</h3>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 field-group">
            <div class="form-label">Vehicle No.</div>
            <input type="text" class="form-control" name="bridgeWasteV">
          </div>
          <div class="col-md-6 field-group">
            <div class="form-label">Type / Origin</div>
            <input type="text" class="form-control" name="bridgeWasteT">
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 field-group">
            <div class="form-label">Permitted Waste</div>
            <select class="form-select" name="cmbPermitedW">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="col-md-6 field-group">
            <div class="form-label">Off-site Queue</div>
            <select class="form-select" name="cmboffQ">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 field-group">
            <div class="form-label">Inspected by EPD</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chktipping1" checked>
              <label class="form-check-label">Checked</label>
            </div>
          </div>
          <div class="col-md-6 field-group">
            <div class="form-label">Inspected by CHEC</div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="chktipping2">
              <label class="form-check-label">Checked</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Waste Inspection (Check >5%)</h3>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-group">
            <div class="form-label">Vehicle No.</div>
            <input type="text" class="form-control" name="tippingWasteV">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Type</div>
            <input type="text" class="form-control" name="tippingWasteT">
          </div>
          <div class="col-md-4 field-group">
            <div class="form-label">Permitted Waste</div>
            <select class="form-select" name="cmbtippingPermitedW">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 field-group">
            <div class="form-label">Traffic Control Signal</div>
            <select class="form-select" name="cmbtippingTraffic">
              <option value="Normal">Normal</option>
              <option value="Abnormal">Abnormal</option>
            </select>
          </div>
          <div class="col-md-6 field-group">
            <div class="form-label">CCTV System</div>
            <select class="form-select" name="cmbtippingCCTV">
              <option value="Normal">Normal</option>
              <option value="Malfunction">Malfunction</option>
            </select>
          </div>
        </div>
<div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">145B</div>
            <input type="text" class="form-control" name="txt145B">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">550FV</div>
            <input type="text" class="form-control" name="txt550FV">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">155WV</div>
            <input type="text" class="form-control" name="txt155W">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Others</div>
            <input type="text" class="form-control" name="txtOthers">
          </div>
        </div>
 	<div class="row">
          <div class="col-md-12 field-group">
            <h3 class="section-header">Remarks</h3>
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 field-group">
            <div class="form-label">Remarks 1</div>
            <input type="text" class="form-control" name="txtRemarks1">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Remarks 2</div>
            <input type="text" class="form-control" name="txtRemarks2">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Remarks 3</div>
            <input type="text" class="form-control" name="txtRemarks3">
          </div>
          <div class="col-md-3 field-group">
            <div class="form-label">Remarks 4</div>
            <input type="text" class="form-control" name="txtRemarks4">
          </div>
        </div>
        


    <div class="navigation-buttons">
          <button type="button" class="btn-previous" id="prev4">Previous</button>
          <button type="submit" class="btn-save" id="save">Save</button>
        </div>
      </div>
    </form>
    <p id="status" class="mt-3"></p>
    <button class="btn-export" id="exportExcelBtn">Export to Excel</button>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let currentPage = 1;
const pages = ['page1', 'page2', 'page3', 'page4'];
let db;
let dbInitialized = false;

// Initialize IndexedDB
const initDB = () => {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('InspectionDB', 3);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains('inspections')) {
                db.createObjectStore('inspections', { keyPath: 'timestamp' });
            }
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            dbInitialized = true;
            resolve(db);
        };
        request.onerror = (e) => reject(e.target.error);
        request.onblocked = () => reject(new Error('Database blocked'));
    });
};

// Set default values for form fields, including all default checkboxes
const setDefaultValues = () => {
    const now = new Date();
    const dateInput = document.querySelector('input[name="txtDate"]');
    if (dateInput) {
        dateInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        console.log('Set default date:', dateInput.value);
    } else {
        console.warn('Date input not found');
    }

    const defaultValues = {
        'cmbInspector': 'I(TD)43', 'cmbWeather': 'Sunny', 'cmbCCTV': 'Normal', 'cmbWeightDis': 'Yes',
        'cmbPermitedW': 'Yes', 'cmboffQ': 'No', 'cmbtippingPermitedW': 'Yes', 'cmbtippingTraffic': 'Normal',
        'cmbtippingCCTV': 'Normal', 'cmbGTW': 'Yes', 'cmbCurtain': 'Yes', 'cmbBefore': 'Normal',
        'cmbAnaerobic': 'Normal', 'cmbFinal': 'Normal', 'cmbFilter': 'Normal', 'cmbBiogas': 'Normal',
        'cmbPenstock': 'Open', 'cmbCleanliness': 'Yes', 'cmbMinutes': 'No', 'cmbHours': 'No',
        'cmbPLC': 'Normal', 'cmbPreT': 'Normal', 'cmbPenstockChamber': 'Open', 'cmbAerobicS': 'Normal',
        'cmbAnaerobicS': 'Normal', 'cmbPostT': 'Normal', 'cmbCent': 'Yes'
    };
    Object.entries(defaultValues).forEach(([name, value]) => {
        const select = document.querySelector(`select[name="${name}"]`);
        if (select) {
            select.value = value;
            console.log(`Set default for ${name}: ${value}`);
        } else {
            console.warn(`Select ${name} not found`);
        }
    });

    const defaultChecked = [
        'chkScreen1', 'chkScreen3', 'chkDAF1', 'chkDAF2', 'chkCrane1', 'chkCrane2', 'chkWash1', 'chkWash2',
        'chkWeightbridge1', 'chkWeightbridge2', 'chkWeightbridge3', 'chkC2', 'chkMF1', 'chkC3', 'chkMF2',
        'chkC4', 'chkMF3', 'chkC5', 'chkMF4', 'chkC6', 'chkMF5', 'chkC7', 'chkMF6', 'chkC8', 'chkC9',
        'chkC10', 'chktipping1', 'chkT300', 'chkT401', 'chkT402', 'chkT403', 'chkT404'
    ];
    defaultChecked.forEach(name => {
        const checkbox = document.querySelector(`input[name="${name}"]`);
        if (checkbox) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
            console.log(`Set ${name} to checked`);
        } else {
            console.warn(`Checkbox ${name} not found in DOM`);
        }
    });
};

// Load saved data from localStorage, only overriding if explicitly set
const loadSavedData = () => {
    const savedData = JSON.parse(localStorage.getItem('inspectionFormData') || '{}');
    console.log('Saved data from localStorage:', savedData);

    document.querySelectorAll('input, select, textarea').forEach(element => {
        if (Object.prototype.hasOwnProperty.call(savedData, element.name)) {
            if (element.type === 'checkbox') {
                const defaultChecked = [
                    'chkScreen1', 'chkScreen3', 'chkDAF1', 'chkDAF2', 'chkCrane1', 'chkCrane2', 'chkWash1', 'chkWash2',
                    'chkWeightbridge1', 'chkWeightbridge2', 'chkWeightbridge3', 'chkC2', 'chkMF1', 'chkC3', 'chkMF2',
                    'chkC4', 'chkMF3', 'chkC5', 'chkMF4', 'chkC6', 'chkMF5', 'chkC7', 'chkMF6', 'chkC8', 'chkC9',
                    'chkC10', 'chktipping1', 'chkT300', 'chkT401', 'chkT402', 'chkT403', 'chkT404'
                ].includes(element.name);
                const savedValue = savedData[element.name] === 'true';
                if (!defaultChecked || savedValue !== defaultChecked) {
                    element.checked = savedValue;
                    console.log(`Loaded ${element.name}: ${defaultChecked} -> ${element.checked}`);
                }
            } else {
                element.value = savedData[element.name];
                console.log(`Loaded saved value for ${element.name}: ${element.value}`);
            }
        }
    });
};

// Format time input (e.g., "1423" -> "14:23")
const formatTimeInput = (input) => {
    let value = input.value.replace(/\D/g, ''); // Remove non-digits
    if (value.length === 4) {
        const hours = value.slice(0, 2);
        const minutes = value.slice(2, 4);
        if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
            input.value = `${hours}:${minutes}`;
            console.log(`Formatted time: ${input.value}`);
        } else {
            input.value = ''; // Clear invalid input
            console.warn(`Invalid time input: ${value}`);
        }
    } else if (value.length > 4) {
        input.value = value.slice(0, 4); // Trim to 4 digits if too long
    }
};

// Format bridgeWasteT input (e.g., "P0112" -> "P01/12" or "D0112" -> "D01/12")
const formatBridgeWasteTInput = (input) => {
    console.log(`Processing bridgeWasteT input: ${input.value}`);
    let value = input.value.toUpperCase(); // Ensure "d" becomes "D"
    console.log(`After uppercasing: ${value}`);
    value = value.replace(/[^DP0-9]/g, ''); // Keep only "D", "P", and digits
    console.log(`After filtering: ${value}`);
    if ((value.startsWith('P') || value.startsWith('D')) && value.length === 5) {
        const prefix = value.charAt(0); // "P" or "D"
        const firstPart = value.slice(1, 3); // e.g., "01"
        const secondPart = value.slice(3, 5); // e.g., "12"
        console.log(`Parsed - Prefix: ${prefix}, First: ${firstPart}, Second: ${secondPart}`);
        if (firstPart.match(/^\d{2}$/) && secondPart.match(/^\d{2}$/)) {
            input.value = `${prefix}${firstPart}/${secondPart}`;
            console.log(`Formatted bridgeWasteT: ${input.value}`);
        } else {
            input.value = ''; // Clear invalid input
            console.warn(`Invalid bridgeWasteT input (non-numeric parts): ${value}`);
        }
    } else if (value.length > 5) {
        input.value = value.slice(0, 5); // Trim to 5 characters if too long
        console.log(`Trimmed to: ${input.value}`);
    }
};
	
// Save data to localStorage on every change
const saveDataOnChange = () => {
    const formData = new FormData(document.getElementById('inspectionForm'));
    const data = Object.fromEntries(formData.entries());
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        data[checkbox.name] = checkbox.checked ? 'true' : 'false';
    });
    localStorage.setItem('inspectionFormData', JSON.stringify(data));
};

// Show/hide pages
const showPage = (pageNum) => {
    pages.forEach(p => document.getElementById(p).classList.add('hidden'));
    document.getElementById(`page${pageNum}`).classList.remove('hidden');
};

// Status messages
const showStatus = (message, type = 'success') => {
    const status = document.getElementById('status');
    status.textContent = message;
    status.style.color = type === 'error' ? '#e74c3c' : '#27ae60';
    setTimeout(() => status.textContent = '', 5000);
};

// Save to IndexedDB
const saveLocally = (data) => {
    return new Promise((resolve, reject) => {
        if (!dbInitialized || !db) reject(new Error('Database not initialized'));
        const tx = db.transaction('inspections', 'readwrite');
        const store = tx.objectStore('inspections');
        store.add(data).onsuccess = resolve;
        store.onerror = (e) => reject(e.target.error);
    });
};

// Reset form and clear storage
const resetForm = () => {
    document.getElementById('inspectionForm').reset();
    localStorage.removeItem('inspectionFormData');
    setDefaultValues();
};

// Validate form
const validateForm = (data) => {
    if (!data.txtDate) return "Date is required";
    if (!data.txtTime.match(/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$/)) return "Invalid time format (HH:MM)";
    if (!data.cmbInspector) return "Inspector is required";
    if (!data.cmbWeather) return "Weather is required";
    return null;
};

// Show loading
const showLoading = (pageNum, show) => {
    document.getElementById(`loading${pageNum}`).style.display = show ? 'flex' : 'none';
};

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded, setting up form');
    setDefaultValues();
    initDB().then(() => {
        loadSavedData();
        showPage(1);
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('change', saveDataOnChange);
            element.addEventListener('input', saveDataOnChange);
        });

        // Add time formatting to txtTime input
        const timeInput = document.querySelector('input[name="txtTime"]');
        if (timeInput) {
            timeInput.addEventListener('input', () => formatTimeInput(timeInput));
            timeInput.addEventListener('change', () => formatTimeInput(timeInput));
            console.log('Time input formatting enabled');
        } else {
            console.warn('Time input (txtTime) not found');
        }
    }).catch(error => console.error('Initialization error:', error));
});

document.querySelector('.container').addEventListener('click', (e) => {
    if (e.target.id.startsWith('next') && currentPage < pages.length) {
        currentPage++;
        showPage(currentPage);
    } else if (e.target.id.startsWith('prev') && currentPage > 1) {
        currentPage--;
        showPage(currentPage);
    }
});

document.getElementById('inspectionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading(4, true);
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.timestamp = new Date().toISOString();
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            data[checkbox.name] = checkbox.checked ? 'true' : 'false';
        });

        const validationError = validateForm(data);
        if (validationError) {
            showStatus(validationError, 'error');
            return;
        }

        await saveLocally(data);
        showStatus('Data saved locally!');
        resetForm();
    } catch (error) {
        showStatus(`Failed to save data: ${error.message}`, 'error');
    } finally {
        showLoading(4, false);
    }
});

document.getElementById('exportExcelBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    if (typeof XLSX === 'undefined') {
        showStatus('Excel library not loaded. Check your connection.', 'error');
        return;
    }
    if (!confirm('Export all local data to Excel and clear the database?')) return;

    showLoading(currentPage, true);

    try {
        if (!dbInitialized || !db) {
            await initDB();
            if (!dbInitialized) throw new Error('Database failed to initialize');
        }

        const tx = db.transaction('inspections', 'readonly');
        const store = tx.objectStore('inspections');
        const data = await new Promise((resolve, reject) => {
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(new Error('Failed to retrieve data'));
        });

        if (!data || data.length === 0) {
            showStatus('No local data to export', 'error');
            return;
        }

        const uppercaseFields = [
            'bridgeWasteV', 'bridgeWasteT', 'tippingWasteV', 'tippingWasteT', 'txtC1', 'txtC2', 'txtC3', 'txtC4', 
            'txtC5', 'txtC6', 'txtC7', 'txtC8', 'txtC9', 'txtC10'
        ];

        const uppercaseData = data.map(item => {
            const newItem = { ...item };
            uppercaseFields.forEach(field => {
                if (newItem[field] && typeof newItem[field] === 'string') {
                    newItem[field] = newItem[field].toUpperCase();
                }
            });
            return newItem;
        });

        const reformatDate = (dateStr) => {
            if (!dateStr) return '';
            if (dateStr.includes('-')) {
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            }
            return dateStr;
        };

        const headers = [
            "Date", "Inspector", "Time", "Weather", "Weightbridge 1", "Weightbridge 2",
            "Weightbridge 3", "Weightbridge 4", "CCTV", "Weight Display", "Vehicle No. (Bridge)",
            "Type/Origin", "Permited Waste", "Off-site Queue", "Inspected by EPD", "Inspected by CHEC",
            "Vehicle No. (Tipping)", "Type (Tipping)", "Permited Waste (Tipping)", "Traffic Control",
            "CCTV (Tipping)", "Filter Press", "C1", "Container No. (C1)", "C2", "Container No. (C2)",
            "MF1", "C3", "Container No. (C3)", "MF2", "C4", "Container No. (C4)", "MF3", "C5",
            "Container No. (C5)", "MF4", "C6", "Container No. (C6)", "MF5", "C7", "Container No. (C7)",
            "MF6", "C8", "Container No. (C8)", "C9", "Container No. (C9)", "C10", "Container No. (C10)",
            "Screen 1", "Screen 2", "Screen 3", "Tank 1A", "Tank 1B", "Tank 2A", "Tank 2B", "DAF 1",
            "DAF 2", "GTW Area", "Crane 1", "Crane 2", "CHU 1", "CHU 2", "145B", "550FV", "155WV",
            "Others", "Lai Wan", "Ngon Shuen", "Vehicle Wash 1", "Vehicle Wash 2", "Vehicle Wash 3",
            "Cleanliness", ">30 mins", "Offsite >24 hrs", "Air Curtain", "Scrubber 1", "Scrubber 2",
            "Scrubber 3", "Scrubber 4", "Scrubber 5", "Acid Stage 1", "Acid Stage 2", "Acid Stage 4",
            "Acid Stage 5", "Alk Stage 1", "Alk Stage 2", "Alk Stage 3", "Alk Stage 4", "Alk Stage 5",
            "ORP Range 1", "ORP Range 2", "ORP Range 3", "ORP Range 4", "ORP Range 5", "Before Treatment",
            "Anaerobic Tanks", "T300", "T401", "T402", "T403", "T404", "Final Clarifier", "Filter Press",
            "Biogas Tank", "Penstock", "Remarks 1", "Remarks 2", "Remarks 3", "Remarks 4", "PLC Condition",
            "Pre Treatment", "Penstock Status", "AerobicS", "AT401", "AT402", "AT403", "AT404",
            "AnaerobicS", "ApH", "ATemp", "ADO", "ABiogas", "Post-Treatment", "Centrifuge", "Wetsep",
            "Marine Vessel", "Storm", "VWF", "Rundown", "101", "100", "313", "312", "410", "413",
            "Public", "Road", "Marine", "Scrubbers", "VWS", "401 DO", "402 DO", "403 DO", "404 DO",
            "401 Temp", "402 Temp", "403 Temp", "404 Temp", "404 pH", "Timestamp"
        ];

        const fieldNames = [
            "txtDate", "cmbInspector", "txtTime", "cmbWeather", "chkWeightbridge1", "chkWeightbridge2",
            "chkWeightbridge3", "chkWeightbridge4", "cmbCCTV", "cmbWeightDis", "bridgeWasteV",
            "bridgeWasteT", "cmbPermitedW", "cmboffQ", "chktipping1", "chktipping2", "tippingWasteV",
            "tippingWasteT", "cmbtippingPermitedW", "cmbtippingTraffic", "cmbtippingCCTV", "txtfPress",
            "chkC1", "txtC1", "chkC2", "txtC2", "chkMF1", "chkC3", "txtC3", "chkMF2", "chkC4",
            "txtC4", "chkMF3", "chkC5", "txtC5", "chkMF4", "chkC6", "txtC6", "chkMF5", "chkC7",
            "txtC7", "chkMF6", "chkC8", "txtC8", "chkC9", "txtC9", "chkC10", "txtC10", "chkScreen1",
            "chkScreen2", "chkScreen3", "txt1A", "txt1B", "txt2A", "txt2B", "chkDAF1", "chkDAF2",
            "cmbGTW", "chkCrane1", "chkCrane2", "chkCHU1", "chkCHU2", "txt145B", "txt550FV",
            "txt155W", "txtOthers", "chkLaiwan", "chkNgonshuen", "chkWash1", "chkWash2", "chkWash3",
            "cmbCleanliness", "cmbMinutes", "cmbHours", "cmbCurtain", "chkScrubber1", "chkScrubber2",
            "chkScrubber3", "chkScrubber4", "chkScrubber5", "txtAcid1", "txtAcid2", "txtAcid4",
            "txtAcid5", "txtAlk1", "txtAlk2", "txtAlk3", "txtAlk4", "txtAlk5", "txtORP1", "txtORP2",
            "txtORP3", "txtORP4", "txtORP5", "cmbBefore", "cmbAnaerobic", "chkT300", "chkT401",
            "chkT402", "chkT403", "chkT404", "cmbFinal", "cmbFilter", "cmbBiogas", "cmbPenstock",
            "txtRemarks1", "txtRemarks2", "txtRemarks3", "txtRemarks4", "cmbPLC", "cmbPreT",
            "cmbPenstockChamber", "cmbAerobicS", "txtAT401", "txtAT402", "txtAT403", "txtAT404",
            "cmbAnaerobicS", "txtApH", "txtATemp", "txtADO", "txtABiogas", "cmbPostT", "cmbCent",
            "txtWetsep", "txtMarineVessel", "txtStorm", "txtVWF", "txtRundown", "txt101", "txt100",
            "txt313", "txt312", "txt410", "txt413", "txtPublic", "txtRoad", "txtMarine", "txtScrubbers",
            "txtVWS", "txt401DO", "txt402DO", "txt403DO", "txt404DO", "txt401Temp", "txt402Temp",
            "txt403Temp", "txt404Temp", "txt404pH", "timestamp"
        ];

        const worksheetData = [
            headers,
            ...uppercaseData.map(item => fieldNames.map(field => {
                if (field === "txtDate" && item[field]) {
                    return reformatDate(item[field]);
                }
                return item[field] || '';
            }))
        ];

        const ws = XLSX.utils.aoa_to_sheet(worksheetData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inspections");

        const now = new Date();
        const hktDate = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        const timestamp = `${hktDate.getUTCFullYear()}${String(hktDate.getUTCMonth() + 1).padStart(2, '0')}${String(hktDate.getUTCDate()).padStart(2, '0')}_${String(hktDate.getUTCHours()).padStart(2, '0')}${String(hktDate.getUTCMinutes()).padStart(2, '0')}${String(hktDate.getUTCSeconds()).padStart(2, '0')}`;
        XLSX.writeFile(wb, `inspections_${timestamp}.xlsx`);

        const clearDB = () => {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('inspections', 'readwrite');
                const store = tx.objectStore('inspections');
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        };

        await clearDB();
        resetForm();

        setTimeout(() => {
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.dispatchEvent(new Event('change'));
                element.dispatchEvent(new Event('input'));
            });
            showStatus('Data exported successfully and form cleared');
        }, 100);
    } catch (error) {
        console.error('Export error:', error);
        showStatus(`Export failed: ${error.message}`, 'error');
    } finally {
        showLoading(currentPage, false);
    }
});
</script>
</body>
</html>
